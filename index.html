<!doctype html>
<html lang="id" class="transition-colors duration-500">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Naseeha Generator</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Google Fonts untuk Arab dan Latin -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Naskh+Arabic:wght@400;500;600;700&display=swap"
    rel="stylesheet">

  <style>
    :root {
      --bg-primary: #f8fafc;
      --bg-secondary: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --border-color: #e2e8f0;
      --accent-color: rgb(42, 154, 245);
    }

    .dark {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border-color: #334155;
      --accent-color: #1a76ee;
    }

    body {
      transition: all 0.5s ease;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .soft-light {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 50%, #cbd5e1 100%);
    }

    .soft-dark {
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
    }

    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 1.5rem;
    }

    /* Font khusus untuk teks Arab */
    .arabic-text {
      font-family: 'Noto Naskh Arabic', serif;
      line-height: 1.8;
    }

    /* Gaya untuk teks yang mengandung Arab dan Latin */
    .mixed-text {
      line-height: 1.6;
    }

    /* Deteksi dan styling untuk teks Arab */
    .tweet-content {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* Direction RTL untuk teks Arab */
    .rtl-text {
      direction: rtl;
      text-align: right;
    }

    /* Custom styles untuk konsistensi dark mode */
    .card {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .input-field {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .input-field::placeholder {
      color: var(--text-secondary);
      opacity: 0.7;
    }

    .text-muted {
      color: var(--text-secondary);
    }

    .btn-primary {
      background-color: var(--accent-color);
      color: white;
    }

    .btn-secondary {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    /* FIX: Struktur yang lebih robust untuk alignment */
    .tweet-container {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .avatar-container {
      flex-shrink: 0;
      width: 48px;
      height: 48px;
    }

    .tweet-avatar {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid var(--border-color);
    }

    .content-container {
      flex: 1;
      min-width: 0;
    }

    .user-info-container {
      display: flex;
      flex-direction: column;
      justify-content: center;
      height: 48px;
      /* Match avatar height exactly */
      margin-bottom: 2px;
    }

    .tweet-display-name {
      font-weight: 600;
      font-size: 16px;
      line-height: 1.25;
      margin: 0;
      padding: 0;
    }

    .tweet-handle {
      font-size: 14px;
      color: var(--text-secondary);
      line-height: 1.25;
      margin: 0;
      padding: 0;
    }

    /* Pastikan tidak ada margin/padding yang tidak perlu */
    .tweet-content {
      margin: 0;
      padding: 0;
    }

    .meta-line {
      margin: 8px 0 0 0;
      padding: 0;
    }

    /* Source text style */
    .source-text {
      font-style: italic;
      color: var(--text-secondary);
      margin-top: 8px;
      font-size: 14px;
      border-left: 2px solid var(--accent-color);
      padding-left: 8px;
    }

    /* Background options styles */
    .bg-option {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }

    .bg-option:hover {
      transform: scale(1.05);
    }

    .bg-option.selected {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 2px var(--accent-color);
    }

    .bg-gradient-blue {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .bg-gradient-purple {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .bg-gradient-green {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .bg-gradient-orange {
      background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .bg-gradient-dark {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
    }

    .bg-gradient-sunset {
      background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
    }

    .bg-gradient-ocean {
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    }

    .bg-gradient-forest {
      background: linear-gradient(135deg, #5ee7df 0%, #b490ca 100%);
    }

    .bg-gradient-sunrise {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
    }

    .bg-gradient-midnight {
      background: linear-gradient(135deg, #0c2461 0%, #1e3799 100%);
    }

    .bg-custom-upload {
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 12px;
      text-align: center;
      padding: 4px;
    }

    /* NEW: Styling untuk posisi preview tetap */
    .preview-container {
      position: sticky;
      top: 20px;
      align-self: flex-start;
    }

    @media (max-width: 768px) {
      .preview-container {
        position: static;
        margin-top: 20px;
      }
    }

    /* Footer Styles */
    .footer-full {
      width: 100%;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: white;
      padding: 2rem 0;
      margin-top: auto;
    }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 1rem;
    }

    .footer-dark {
      background: linear-gradient(135deg, #0a0f1c 0%, #1a2438 100%);
    }

    .footer-light {
      background: linear-gradient(135deg, #334155 0%, #475569 100%);
    }

    /* Instagram icon styling */
    .instagram-icon {
     
      border-radius: 8px;
      padding: 8px;
      transition: transform 0.3s ease;
    }

    .instagram-icon:hover {
      transform: scale(1.1);
    }
  </style>
</head>

<body class="min-h-screen flex flex-col">

  <!-- Loading Indicator -->
  <div id="loading" class="loading">
    <div class="card p-6 rounded-lg shadow-lg">
      <div class="flex items-center gap-3">
        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
        <span class="text-slate-800 dark:text-slate-200">Menyiapkan unduhan...</span>
      </div>
    </div>
  </div>

  <div class="flex-grow flex items-start justify-center py-10">
    <div class="max-w-6xl w-full px-4 grid md:grid-cols-2 gap-8">

      <!-- LEFT CONTROL PANEL -->
      <div class="space-y-5">
        <h1 class="text-2xl font-bold">Naseeha Generator</h1>

        <!-- Avatar -->
        <div class="card p-4 rounded-xl shadow space-y-3">
          <label class="block text-sm font-medium">Upload Foto</label>
          <div class="flex items-center gap-3">
            <img id="avatarPreview" src="https://cdn-icons-png.flaticon.com/512/4140/4140045.png"
              class="w-16 h-16 rounded-full object-cover border border-slate-300 dark:border-slate-600" />
            <div class="flex flex-col">
              <input id="avatarInput" type="file" accept="image/*"
                class="text-sm mb-2 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-slate-700 dark:file:text-slate-300" />
              <button id="removeAvatar"
                class="text-xs text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 text-left">Hapus
                Foto</button>
            </div>
          </div>
        </div>

        <!-- Text Inputs -->
        <div class="card p-4 rounded-xl shadow space-y-3">
          <label class="block text-sm font-medium">Nama</label>
          <input id="name" class="input-field w-full px-3 py-2 rounded-lg placeholder-slate-500"
            placeholder="Masukkan nama" maxlength="50">

          <label class="block text-sm font-medium">Username</label>
          <div class="relative">
            <span class="absolute left-3 top-2 text-muted">@</span>
            <input id="username" class="input-field w-full pl-7 pr-3 py-2 rounded-lg placeholder-slate-500"
              placeholder="Masukkan username" maxlength="15">
          </div>

          <label class="block text-sm font-medium">Teks</label>
          <div class="relative">
            <textarea id="tweetText" rows="4" class="input-field w-full px-3 py-2 rounded-lg placeholder-slate-500"
              maxlength="1000" placeholder="Tulis tweet Anda di sini...">Tulis disini dengan #hashtag

ÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê

"Dengan nama Allah yang Maha Pengasih lagi Maha Penyayang"</textarea>
            <div id="charCount"
              class="absolute bottom-2 right-2 text-xs text-muted bg-white dark:bg-slate-700 px-1 rounded">1000/1000</div>
          </div>

          <label class="block text-sm font-medium">Sumber / Referensi</label>
          <input id="sourceText" class="input-field w-full px-3 py-2 rounded-lg placeholder-slate-500"
            placeholder="Contoh: HR. Bukhari no. 1234, atau nama buku, dll" maxlength="100">

          <label class="block text-sm font-medium">Lokasi</label>
          <input id="location" class="input-field w-full px-3 py-2 rounded-lg placeholder-slate-500"
            placeholder="Contoh: Bengkulu, Indonesia" maxlength="30">
        </div>

        <!-- Background Options untuk Story -->
        <div class="card p-4 rounded-xl shadow space-y-3">
          <label class="block text-sm font-medium">Background Story</label>
          <div class="text-xs text-muted mb-3">Pilih background untuk download story</div>

          <div class="grid grid-cols-5 gap-3">
            <!-- Default backgrounds -->
            <div class="bg-option soft-light selected" data-bg="soft-light" title="Light Mode"></div>
            <div class="bg-option soft-dark" data-bg="soft-dark" title="Dark Mode"></div>
            <div class="bg-option bg-gradient-blue" data-bg="gradient-blue" title="Blue Gradient"></div>
            <div class="bg-option bg-gradient-purple" data-bg="gradient-purple" title="Purple Gradient"></div>
            <div class="bg-option bg-gradient-green" data-bg="gradient-green" title="Green Gradient"></div>
            <div class="bg-option bg-gradient-orange" data-bg="gradient-orange" title="Orange Gradient"></div>
            <div class="bg-option bg-gradient-dark" data-bg="gradient-dark" title="Dark Gradient"></div>
            <div class="bg-option bg-gradient-sunset" data-bg="gradient-sunset" title="Sunset Gradient"></div>
            <div class="bg-option bg-gradient-ocean" data-bg="gradient-ocean" title="Ocean Gradient"></div>
            <div class="bg-option bg-gradient-forest" data-bg="gradient-forest" title="Forest Gradient"></div>
            <div class="bg-option bg-gradient-sunrise" data-bg="gradient-sunrise" title="Sunrise Gradient"></div>
            <div class="bg-option bg-gradient-midnight" data-bg="gradient-midnight" title="Midnight Gradient"></div>

            <!-- Custom background upload -->
            <div class="bg-option bg-custom-upload" data-bg="custom" title="Upload Custom Background">
              <div>
                <span>üì∑</span>
                <div class="text-xs mt-1">Custom</div>
              </div>
            </div>
          </div>

          <!-- Custom background upload input (hidden by default) -->
          <div id="customBgUpload" class="hidden mt-3">
            <label class="block text-xs font-medium mb-2">Upload Background Custom</label>
            <input id="customBgInput" type="file" accept="image/*"
              class="w-full text-xs file:mr-2 file:py-1 file:px-3 file:rounded file:border-0 file:text-xs file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 dark:file:bg-slate-700 dark:file:text-slate-300">
            <div class="text-xs text-muted mt-1">Rekomendasi: 1080x1920px (rasio 9:16)</div>
          </div>

          <!-- Preview custom background -->
          <div id="customBgPreview" class="hidden mt-3">
            <label class="block text-xs font-medium mb-2">Preview Background Custom</label>
            <div class="relative">
              <img id="customBgPreviewImg"
                class="w-full h-32 object-cover rounded-lg border border-slate-300 dark:border-slate-600">
              <button id="removeCustomBg"
                class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                √ó
              </button>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="card p-4 rounded-xl shadow space-y-4">
          <div class="flex flex-wrap gap-2">
            <button id="downloadTweet"
              class="btn-primary px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors font-medium">Download
              PNG</button>
            <button id="downloadStory"
              class="btn-primary px-4 py-2 rounded-lg shadow hover:bg-indigo-700 transition-colors font-medium">Download
              Story</button>
            <button id="darkToggle"
              class="btn-secondary px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-600 transition font-medium">
              <span id="darkIcon">üåô</span>
              <span id="darkText">Mode Gelap</span>
            </button>
            <button id="resetAll"
              class="btn-secondary px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-red-50 dark:hover:bg-red-900/20 transition font-medium text-red-600 dark:text-red-400 border-red-300 dark:border-red-700">
              <span>Reset</span>
            </button>
          </div>
        </div>
      </div>

      <!-- RIGHT PREVIEW - MODIFIED WITH STICKY POSITION -->
      <div class="preview-container">
        <div id="tweetCard" class="card p-5 rounded-2xl shadow-lg w-full max-w-[500px] transition-all">
          <!-- FIX: Struktur yang lebih sederhana dan konsisten -->
          <div class="tweet-container">
            <div class="avatar-container mt-2">
              <img id="avatar" src="https://cdn-icons-png.flaticon.com/512/4140/4140045.png" class="tweet-avatar">
            </div>
            <div class="content-container">
              <div class="user-info-container">
                <div id="displayName" class="tweet-display-name">Nama</div>
                <div id="handle" class="tweet-handle">@username</div>
              </div>
              <div id="tweetContent" class="tweet-content text-lg leading-6 mr-5">
                Teks contoh disini üåô <span class="text-blue-600 dark:text-blue-400">#hashtag</span>
              </div>

              <!-- Source Text Display -->
              <div id="sourceDisplay" class="source-text"></div>

              <div id="metaLine" class="meta-line text-sm text-muted mb-3"></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- FOOTER FULL WIDTH -->
  <footer class="footer-full">
    <div class="footer-content">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <!-- Logo dan Kredit -->
        <div class="mb-4 md:mb-0">
          <div class="flex items-center space-x-2">
            <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
              <span class="text-white font-bold text-sm">N</span>
            </div>
            <span class="font-semibold text-lg">Naseeha Generator</span>
          </div>
          <p class="text-slate-300 text-sm mt-2">Dibuat dengan ‚ù§Ô∏è oleh <span class="font-medium">abdr.rhmn</span></p>
        </div>
        
        <!-- Instagram Link Only -->
        <div class="flex space-x-4">
          <a href="https://www.instagram.com/abdurrahman.solih/" target="_blank" class="text-slate-300 hover:text-white transition-colors duration-300">
            <div class="instagram-icon">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
              </svg>
            </div>
          </a>
        </div>
      </div>
      
      <!-- Garis pemisah -->
      <div class="border-t border-slate-700 mt-6 pt-6 flex flex-col md:flex-row justify-between items-center">
        <p class="text-slate-400 text-sm text-center md:text-left mb-4 md:mb-0">
          ¬© 2025 Naseeha Generator. Semua hak dilindungi.
        </p>
        <div class="flex space-x-4 text-sm">
          <a href="#" class="text-slate-400 hover:text-white transition-colors duration-300">Kebijakan Privasi</a>
          <a href="#" class="text-slate-400 hover:text-white transition-colors duration-300">Syarat & Ketentuan</a>
          <a href="#" class="text-slate-400 hover:text-white transition-colors duration-300">Kontak</a>
        </div>
      </div>
    </div>
  </footer>

  <!-- SCRIPT -->
  <script>
    // === KONSTANTA ===
    const bulanSingkat = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun",
      "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
    const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/4140/4140045.png";

    // Regex untuk mendeteksi karakter Arab
    const arabicRegex = /[\u0600-\u06FF]/;

    // === ELEMENTS ===
    const elements = {
      avatarInput: document.getElementById('avatarInput'),
      avatarPreview: document.getElementById('avatarPreview'),
      avatar: document.getElementById('avatar'),
      nameInput: document.getElementById('name'),
      usernameInput: document.getElementById('username'),
      tweetTextInput: document.getElementById('tweetText'),
      sourceTextInput: document.getElementById('sourceText'),
      locationInput: document.getElementById('location'),
      displayName: document.getElementById('displayName'),
      handle: document.getElementById('handle'),
      tweetContent: document.getElementById('tweetContent'),
      sourceDisplay: document.getElementById('sourceDisplay'),
      metaLine: document.getElementById('metaLine'),
      tweetCard: document.getElementById('tweetCard'),
      darkToggle: document.getElementById('darkToggle'),
      darkIcon: document.getElementById('darkIcon'),
      darkText: document.getElementById('darkText'),
      removeAvatar: document.getElementById('removeAvatar'),
      charCount: document.getElementById('charCount'),
      resetAll: document.getElementById('resetAll'),
      loading: document.getElementById('loading'),
      customBgInput: document.getElementById('customBgInput'),
      customBgUpload: document.getElementById('customBgUpload'),
      customBgPreview: document.getElementById('customBgPreview'),
      customBgPreviewImg: document.getElementById('customBgPreviewImg'),
      removeCustomBg: document.getElementById('removeCustomBg')
    };

    // === STATE VARIABLES ===
    let selectedBackground = 'soft-light';
    let customBackgroundUrl = null;

    // === UTILITY FUNCTIONS ===

    // Format tanggal: Jumat, 24 Okt 2025
    function formatTanggal(now) {
      const tgl = now.getDate();
      const bln = bulanSingkat[now.getMonth()];
      const thn = now.getFullYear();
      return `${tgl} ${bln} ${thn}`;
    }

    // Update preview timestamp
    function updateTimestamp() {
      const now = new Date();
      const jam = now.getHours().toString().padStart(2, '0') + ':' +
        now.getMinutes().toString().padStart(2, '0');
      elements.metaLine.textContent = `${jam} ¬∑ ${formatTanggal(now)} ¬∑ ${elements.locationInput.value}`;
    }

    // Update character count
    function updateCharCount() {
      const currentLength = elements.tweetTextInput.value.length;
      elements.charCount.textContent = `${currentLength}/1000`;

      // Change color if approaching limit
      if (currentLength > 950) {
        elements.charCount.classList.add('text-red-600');
        elements.charCount.classList.remove('text-muted');
      } else {
        elements.charCount.classList.remove('text-red-600');
        elements.charCount.classList.add('text-muted');
      }
    }

    // Fungsi untuk memproses teks dan menerapkan styling yang sesuai
    function processTweetText(text) {
      // Pisahkan teks menjadi baris-baris
      const lines = text.split('\n');
      let processedHTML = '';

      // Filter baris kosong di akhir
      let lastNonEmptyIndex = lines.length - 1;
      while (lastNonEmptyIndex >= 0 && lines[lastNonEmptyIndex].trim() === '') {
        lastNonEmptyIndex--;
      }

      lines.forEach((line, index) => {
        if (line.trim() === '') {
          // Baris kosong - hanya tambahkan jika bukan di akhir dan ada konten setelahnya
          if (index < lastNonEmptyIndex) {
            processedHTML += '<div class="h-4"></div>';
          }
        } else {
          // Periksa apakah baris mengandung teks Arab
          const hasArabic = arabicRegex.test(line);

          // Proses hashtags dan styling
          let processedLine = line.replace(/#(\w+)/g, '<span class="text-blue-600 dark:text-blue-400 font-medium">#$1</span>');

          // Terapkan kelas yang sesuai
          const textClass = hasArabic ? 'arabic-text rtl-text' : 'mixed-text';

          processedHTML += `<div class="${textClass}">${processedLine}</div>`;
        }
      });

      return processedHTML;
    }

    // Update source text display
    function updateSourceDisplay() {
      const sourceText = elements.sourceTextInput.value.trim();
      if (sourceText) {
        elements.sourceDisplay.textContent = `${sourceText}`;
        elements.sourceDisplay.style.display = 'block';
      } else {
        elements.sourceDisplay.style.display = 'none';
      }
    }

    // Update preview content
    function updatePreview() {
      elements.displayName.textContent = elements.nameInput.value || "Nama";
      elements.handle.textContent = '@' + (elements.usernameInput.value || "username");

      // Proses teks tweet dengan dukungan multi-line dan Arab
      elements.tweetContent.innerHTML = processTweetText(elements.tweetTextInput.value);

      // Update source text
      updateSourceDisplay();

      updateTimestamp();
      updateCharCount();
      saveCache();
    }

    // Simpan ke localStorage
    function saveCache() {
      const data = {
        name: elements.nameInput.value,
        username: elements.usernameInput.value,
        sourceText: elements.sourceTextInput.value,
        location: elements.locationInput.value,
        avatar: elements.avatar.src,
        selectedBackground: selectedBackground,
        customBackgroundUrl: customBackgroundUrl
      };
      localStorage.setItem('tweetCache', JSON.stringify(data));
    }

    // Ambil cache dari localStorage
    function loadCache() {
      const cache = JSON.parse(localStorage.getItem('tweetCache') || '{}');
      if (cache.name) elements.nameInput.value = cache.name;
      if (cache.username) elements.usernameInput.value = cache.username;
      if (cache.sourceText) elements.sourceTextInput.value = cache.sourceText;
      if (cache.location) elements.locationInput.value = cache.location;
      if (cache.avatar && cache.avatar !== DEFAULT_AVATAR) {
        elements.avatar.src = cache.avatar;
        elements.avatarPreview.src = cache.avatar;
      }
      if (cache.selectedBackground) {
        selectBackground(cache.selectedBackground);
      }
      if (cache.customBackgroundUrl) {
        customBackgroundUrl = cache.customBackgroundUrl;
        elements.customBgPreviewImg.src = cache.customBackgroundUrl;
        elements.customBgPreview.classList.remove('hidden');
      }
      updatePreview();
    }

    // Reset semua input
    function resetAll() {
      if (confirm('Apakah Anda yakin ingin mengatur ulang semua input?')) {
        elements.nameInput.value = '';
        elements.usernameInput.value = '';
        elements.tweetTextInput.value = 'The real voyage of discovery consists not in seeking new lands, but seeing with new eyes. ‚ù§ #proust\n\nÿ®Ÿêÿ≥ŸíŸÖŸê ÿßŸÑŸÑŸéŸëŸáŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸíŸÖŸéŸÜŸê ÿßŸÑÿ±ŸéŸëÿ≠ŸêŸäŸÖŸê\n\n"Innovation distinguishes between a leader and a follower." - Steve Jobs';
        elements.sourceTextInput.value = '';
        elements.locationInput.value = '';
        elements.avatar.src = DEFAULT_AVATAR;
        elements.avatarPreview.src = DEFAULT_AVATAR;
        elements.avatarInput.value = '';

        // Reset background
        selectBackground('soft-light');
        customBackgroundUrl = null;
        elements.customBgInput.value = '';
        elements.customBgUpload.classList.add('hidden');
        elements.customBgPreview.classList.add('hidden');

        updatePreview();
        saveCache();
      }
    }

    // Toggle dark mode dengan update CSS variables
    function toggleDarkMode() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.setItem('darkMode', isDark);

      // Update button text
      elements.darkIcon.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      elements.darkText.textContent = isDark ? 'Mode Terang' : 'Mode Gelap';

      // Update background class
      if (isDark) {
        document.body.classList.remove('soft-light');
        document.body.classList.add('soft-dark');
      } else {
        document.body.classList.remove('soft-dark');
        document.body.classList.add('soft-light');
      }

      updatePreview();
    }

    // Background selection functions
    function selectBackground(bgType) {
      // Remove selected class from all options
      document.querySelectorAll('.bg-option').forEach(option => {
        option.classList.remove('selected');
      });

      // Add selected class to chosen option
      const selectedOption = document.querySelector(`[data-bg="${bgType}"]`);
      if (selectedOption) {
        selectedOption.classList.add('selected');
      }

      selectedBackground = bgType;

      // Show/hide custom upload section
      if (bgType === 'custom') {
        elements.customBgUpload.classList.remove('hidden');
      } else {
        elements.customBgUpload.classList.add('hidden');
      }

      saveCache();
    }

    function handleCustomBackgroundUpload(file) {
      if (!file) return;

      // Validasi tipe file
      if (!file.type.match('image.*')) {
        alert('Hanya file gambar yang diizinkan');
        return;
      }

      // Validasi ukuran file (maks 10MB)
      if (file.size > 10 * 1024 * 1024) {
        alert('Ukuran file maksimal 10MB');
        return;
      }

      const reader = new FileReader();
      reader.onload = ev => {
        customBackgroundUrl = ev.target.result;
        elements.customBgPreviewImg.src = customBackgroundUrl;
        elements.customBgPreview.classList.remove('hidden');
        saveCache();
      };
      reader.readAsDataURL(file);
    }

    function removeCustomBackground() {
      customBackgroundUrl = null;
      elements.customBgInput.value = '';
      elements.customBgPreview.classList.add('hidden');
      selectBackground('soft-light');
      saveCache();
    }

    // Get background style for story
    function getBackgroundStyle() {
      if (selectedBackground === 'custom' && customBackgroundUrl) {
        return {
          background: `url(${customBackgroundUrl}) center/cover no-repeat`
        };
      } else {
        // Return class name for predefined backgrounds
        return {
          className: selectedBackground === 'soft-light' ? 'soft-light' :
            selectedBackground === 'soft-dark' ? 'soft-dark' :
              `bg-${selectedBackground}`
        };
      }
    }

    // === EVENT HANDLERS ===

    // Input listeners
    [elements.nameInput, elements.usernameInput, elements.tweetTextInput, elements.sourceTextInput, elements.locationInput].forEach(el =>
      el.addEventListener('input', updatePreview)
    );

    // Avatar upload
    elements.avatarInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;

      // Validasi tipe file
      if (!file.type.match('image.*')) {
        alert('Hanya file gambar yang diizinkan');
        return;
      }

      // Validasi ukuran file (maks 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Ukuran file maksimal 5MB');
        return;
      }

      const reader = new FileReader();
      reader.onload = ev => {
        elements.avatar.src = ev.target.result;
        elements.avatarPreview.src = ev.target.result;
        saveCache();
      };
      reader.readAsDataURL(file);
    });

    // Hapus avatar
    elements.removeAvatar.addEventListener('click', () => {
      elements.avatar.src = DEFAULT_AVATAR;
      elements.avatarPreview.src = DEFAULT_AVATAR;
      elements.avatarInput.value = '';
      saveCache();
    });

    // Dark mode toggle
    elements.darkToggle.addEventListener('click', toggleDarkMode);

    // Reset all button
    elements.resetAll.addEventListener('click', resetAll);

    // Background selection
    document.querySelectorAll('.bg-option').forEach(option => {
      option.addEventListener('click', () => {
        const bgType = option.getAttribute('data-bg');
        selectBackground(bgType);
      });
    });

    // Custom background upload
    elements.customBgInput.addEventListener('change', e => {
      const file = e.target.files[0];
      handleCustomBackgroundUpload(file);
    });

    // Remove custom background
    elements.removeCustomBg.addEventListener('click', removeCustomBackground);

    // === DOWNLOAD FUNCTIONS ===

    // Tampilkan loading
    function showLoading() {
      elements.loading.style.display = 'flex';
    }

    // Sembunyikan loading
    function hideLoading() {
      elements.loading.style.display = 'none';
    }

    // Download element sebagai PNG
    async function downloadElement(el, name, width, height) {
      try {
        showLoading();

        const canvas = await html2canvas(el, {
          backgroundColor: null,
          scale: 2,
          width,
          height,
          useCORS: true,
          logging: false,
          onclone: function (clonedDoc) {
            // ‚úÖ Konsistensi tampilan card seperti mode story
            const clonedCard = clonedDoc.getElementById('tweetCard');
            if (clonedCard) {
              // Reset semua margin/padding agar layout rapi
              clonedCard.querySelectorAll('*').forEach(el => {
                el.style.margin = '0';
                el.style.padding = '0';
                el.style.boxSizing = 'border-box';
              });

              // Struktur utama
              const container = clonedCard.querySelector('.tweet-container');
              if (container) {
                container.style.display = 'flex';
                container.style.alignItems = 'flex-start';
                container.style.gap = '12px';
              }

              const userInfo = clonedCard.querySelector('.user-info-container');
              if (userInfo) {
                userInfo.style.display = 'flex';
                userInfo.style.flexDirection = 'column';
                userInfo.style.justifyContent = 'center';
                userInfo.style.height = '48px';
                userInfo.style.marginBottom = '2px';
              }

              // ‚úÖ Penyesuaian posisi border (bar) agar sejajar tengah teks
              const bars = clonedCard.querySelectorAll('.border-bar');
              bars.forEach(bar => {
                const top = parseFloat(bar.style.top) || 0;
                // turunkan sedikit biar sejajar tengah teks
                bar.style.top = (top + 4) + 'px';
              });

              // ‚úÖ Pastikan teks tidak bergeser dan rapi
              const sourceText = clonedCard.querySelector('.source-text');
              if (sourceText) {
                sourceText.style.display = 'inline-flex';
                sourceText.style.alignItems = 'center';
                sourceText.style.paddingLeft = '10px';
                sourceText.style.borderLeft = '3px solid rgb(42,154,245)';
                sourceText.style.lineHeight = '1.6';
                sourceText.style.fontStyle = 'italic';
                sourceText.style.fontSize = '14px';
                sourceText.style.color = '#94a3b8';
                sourceText.style.marginTop = '12px';
                sourceText.style.boxSizing = 'border-box';
              }
            }
          }
        });

        const link = document.createElement('a');
        link.download = name + '.png';
        link.href = canvas.toDataURL();
        link.click();

        hideLoading();
      } catch (error) {
        console.error('Download error:', error);
        alert('Terjadi kesalahan saat mengunduh. Silakan coba lagi.');
        hideLoading();
      }
    }

    // Download tweet normal
    document.getElementById('downloadTweet').addEventListener('click', () => {
      downloadElement(elements.tweetCard, 'naseeha', elements.tweetCard.offsetWidth, elements.tweetCard.offsetHeight);
    });

    // Download story
    document.getElementById('downloadStory').addEventListener('click', async () => {
      try {
        showLoading();

        const wrapper = document.createElement('div');
        wrapper.style.width = '1080px';
        wrapper.style.height = '1920px';
        wrapper.style.display = 'flex';
        wrapper.style.alignItems = 'center';
        wrapper.style.justifyContent = 'center';
        wrapper.style.position = 'fixed';
        wrapper.style.left = '-9999px';
        wrapper.style.borderRadius = '0';

        // Apply selected background
        const backgroundStyle = getBackgroundStyle();
        if (backgroundStyle.className) {
          wrapper.className = backgroundStyle.className;
        } else {
          Object.assign(wrapper.style, backgroundStyle);
        }

        const clone = elements.tweetCard.cloneNode(true);

        // Pastikan container relatif supaya bar bisa diposisikan absolut di dalamnya
        const contentContainer = clone.querySelector('.content-container');
        if (contentContainer) contentContainer.style.position = 'relative';

        clone.style.transform = 'scale(1.8)';
        clone.style.transformOrigin = 'center';
        clone.style.borderRadius = '24px';
        clone.style.boxShadow = '0 12px 32px rgba(0,0,0,0.25)';

        // Hapus border-left lama supaya tidak menggandakan garis
        const sourceText = clone.querySelector('.source-text');
        if (sourceText) {
          sourceText.style.borderLeft = 'none';
          sourceText.style.paddingLeft = '12px';
          sourceText.style.fontStyle = 'italic';
          sourceText.style.fontSize = '14px';
          sourceText.style.lineHeight = '1.6';
          sourceText.style.color = '#94a3b8';
          sourceText.style.display = 'block';
          sourceText.style.boxSizing = 'border-box';
          sourceText.style.marginTop = '12px';
        }

        wrapper.appendChild(clone);
        document.body.appendChild(wrapper);

        // beri waktu browser layout setelah append (important)
        await new Promise(r => setTimeout(r, 80));

        // sekarang hitung posisi dan tinggi sourceText di dalam contentContainer
        if (contentContainer && sourceText) {
          // offsetTop/offsetHeight bekerja dengan transform tetap (transform akan diskalakan juga)
          const top = sourceText.offsetTop;
          const height = sourceText.offsetHeight;

          // hitung posisi kiri bar: sedikit di kiri teks (sesuaikan -10 jika perlu)
          const left = Math.max((sourceText.offsetLeft || 0) - 10, 0);

          // buat elemen bar yang akan menggantikan border-left
          const bar = document.createElement('div');
          bar.style.position = 'absolute';
          bar.style.left = left + 'px';
          bar.style.top = (top + 8) + 'px';
          bar.style.width = '3px';
          bar.style.height = height + 'px';
          bar.style.backgroundColor = 'rgb(42,154,245)';
          bar.style.borderRadius = '2px';
          bar.style.boxSizing = 'border-box';
          // berikan z-index agar tampak di depan latar tapi di belakang teks (jika perlu)
          bar.style.zIndex = '1';

          // tempatkan bar ke dalam contentContainer (relative)
          contentContainer.appendChild(bar);

          // Pastikan teks muncul di atas bar
          sourceText.style.position = 'relative';
          sourceText.style.zIndex = '2';
        }

        // tunggu sejenak agar DOM final tertata sebelum di-screenshot
        await new Promise(r => setTimeout(r, 150));
        await downloadElement(wrapper, 'naseeha-story', 1080, 1920);

        // cleanup
        document.body.removeChild(wrapper);
      } catch (error) {
        console.error('Story download error:', error);
        alert('Terjadi kesalahan saat mengunduh story. Silakan coba lagi.');
        hideLoading();
      }
    });

    // === INITIALIZATION ===

    // Load dark mode preference
    function initializeDarkMode() {
      const savedDarkMode = localStorage.getItem('darkMode') === 'true';

      if (savedDarkMode) {
        document.documentElement.classList.add('dark');
        document.body.classList.add('soft-dark');
        document.body.classList.remove('soft-light');
        elements.darkIcon.textContent = '‚òÄÔ∏è';
        elements.darkText.textContent = 'Mode Terang';
      } else {
        document.documentElement.classList.remove('dark');
        document.body.classList.add('soft-light');
        document.body.classList.remove('soft-dark');
        elements.darkIcon.textContent = 'üåô';
        elements.darkText.textContent = 'Mode Gelap';
      }
    }

    // Initialize
    initializeDarkMode();
    loadCache();
  </script>
</body>
</html>